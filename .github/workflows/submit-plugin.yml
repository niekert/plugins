name: Submit Plugin

on:
  # Manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      plugin_path:
        description: 'Plugin directory (e.g., plugins/csv-import)'
        required: true
        type: string
      changelog:
        description: 'Changelog for this version'
        required: true
        type: string
      dry_run:
        description: 'Dry run (skip submission and tagging)'
        required: false
        default: false
        type: boolean

  # Reusable workflow - can be called from other repos (e.g., framer/workshop)
  workflow_call:
    inputs:
      plugin_path:
        description: 'Plugin directory (e.g., plugins/csv-import)'
        required: true
        type: string
      changelog:
        description: 'Changelog for this version'
        required: true
        type: string
      dry_run:
        description: 'Dry run (skip submission and tagging)'
        required: false
        default: false
        type: boolean
      creators_api_base:
        description: 'Override Framer API base URL'
        required: false
        type: string
    secrets:
      SESSION_TOKEN:
        description: 'Framer session cookie'
        required: true
      FRAMER_ADMIN_SECRET:
        description: 'Framer admin API key'
        required: true
      SLACK_WEBHOOK_URL:
        description: 'Slack webhook URL for notifications'
        required: false

jobs:
  submit:
    name: Submit Plugin
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate plugin path
        run: |
          if [ ! -d "${{ github.workspace }}/${{ inputs.plugin_path }}" ]; then
            echo "Error: Plugin path '${{ inputs.plugin_path }}' does not exist"
            echo ""
            echo "Available plugins:"
            ls -1 plugins/
            exit 1
          fi
          if [ ! -f "${{ github.workspace }}/${{ inputs.plugin_path }}/framer.json" ]; then
            echo "Error: No framer.json found in '${{ inputs.plugin_path }}'"
            exit 1
          fi
          echo "Plugin path validated: ${{ inputs.plugin_path }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .tool-versions

      - name: Install dependencies
        run: yarn install
        env:
          YARN_ENABLE_HARDENED_MODE: 1

      - name: Submit plugin
        run: yarn tsx scripts/submit-plugin.ts
        env:
          PLUGIN_PATH: ${{ github.workspace }}/${{ inputs.plugin_path }}
          CHANGELOG: ${{ inputs.changelog }}
          SESSION_TOKEN: ${{ secrets.SESSION_TOKEN }}
          FRAMER_ADMIN_SECRET: ${{ secrets.FRAMER_ADMIN_SECRET }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          CREATORS_API_BASE: ${{ inputs.creators_api_base || vars.CREATORS_API_BASE }}
          DRY_RUN: ${{ inputs.dry_run }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
